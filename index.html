<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" /><title>Mon Sidescroller</title>
    <script
    src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css"> body { margin: 0; }</style>
</head>



<body>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas {
            width: 100vmin;
        }
    </style>

    <script type="text/javascript">
        
        var config = {
            type: Phaser.AUTO,
            width: 320, height: 240,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: true
                }},
                scene: {preload: preload, create: create, update: update },
                antialias: false
            };
            
            new Phaser.Game(config);
            
            function preload(){
                // chargement tuiles de jeu
                this.load.image("Phaser_tuilesdejeu", "assets/tuileJeu.png");
                
                this.load.image("background", "assets/Background.png");
                
                // chargement de la carte
                this.load.tilemapTiledJSON("carte", "assets/map.json"); 
                
                // chargement du sprite du personnage
                this.load.spritesheet('perso','assets/perso.png',
                { frameWidth: 32, frameHeight: 52 });
                // chargement de l'enemi
                this.load.spritesheet('enemi','assets/enemis.png',
                { frameWidth: 32, frameHeight: 52 });
                
            }
            
            
            function create(){

                // chargement du background
                this.add.image(800, 800, "background");
                
                // chargement de la carte
                const carteDuNiveau = this.add.tilemap("carte");


                // chargement du jeu de tuiles
                const tileset = carteDuNiveau.addTilesetImage(
                "tuiles_de_jeu",
                "Phaser_tuilesdejeu"
                ); 
                
                
                // chargement du calque calque_background
                const calque_background = carteDuNiveau.createLayer(
                "calque_background",
                tileset
                );
                
                // chargement du calque calque_plateformes
                const calque_plateformes = carteDuNiveau.createLayer(
                "calque_plateformes",
                tileset
                );
                // chargement du calque calque_echelle
                const calque_echelle = carteDuNiveau.createLayer(
                "calque_echelle",
                tileset
                ); 


                //chargement du sprite du personage
                this.player = this.physics.add.sprite(10, 0, 'perso');
                
                //chargement du sprite de l'enemi
                this.enemi = this.physics.add.sprite(10, 45, 'enemis');

                //permet la colision avec les bordures d'écran
                this.player.setCollideWorldBounds(true);
                this.physics.world.setBounds(0, 0, 1600, 1600);
                
                
                // définition des tuiles de plateformes qui sont solides
                // utilisation de la propriété estSolide
                calque_plateformes.setCollisionByProperty({ estSolide: true });  
                
                
                // ajout d'une collision entre le joueur et l'enemi avec le calque plateformes
                this.physics.add.collider(this.player, calque_plateformes);
                this.physics.add.collider(this.enemi, calque_plateformes);
                
                // fonction de debug 
                function debug_echelle(){
                    console.log("Est sur echelle");

                }

                
                
                //ajout d'une camera
                this.cameras.main.setBounds(0, 0, 1600, 1600);
                this.cameras.main.zoom = 1;
                this.cameras.main.startFollow(this.player);
                
                // ancrage de la caméra sur le joueur
                this.cameras.main.startFollow(this.player);  
                
                
                // prise en charge des touches
                this.cursors = this.input.keyboard.createCursorKeys();
                this.clavier = this.input.keyboard.addKeys('Q,D,SPACE');
                
                // utilisation de la propiété estEchelle (abandonné)
                //calque_plateformes.setCollisionByProperty({ estEchelle: true });
                
                // #region DEBUG
                /*
                const debugGraphics = this.add.graphics().setAlpha(0.75);
                calque_plateformes.renderDebug(debugGraphics, {
                    tileColor: null, // Color of non-colliding tiles
                    collidingTileColor: new Phaser.Display.Color(255, 0, 0, 64), // Color of colliding tiles
                    faceColor: new Phaser.Display.Color(255, 0, 0, 255) // Color of colliding face edges
                });
                */        
                // #endregion

            }  
            
            // declaration variable  et fonction pour wall jump
            var wallJump = true;
            var pDeplacementY = 210;
            function blocageTouche () {
                offTouche = false;
            }
            function cdWallJump () {
                wallJump = true;
            }
             


            function update(){
                // Comportement - Joueur
                // Ici, c'est tout simplement le code pour gérer le déplacement de mon joueur
                if (this.cursors.left.isDown || this.clavier.Q.isDown){ 
                    this.player.setVelocityX(-160); 
                    
                }
                else if (this.cursors.right.isDown || this.clavier.D.isDown){ 
                    this.player.setVelocityX(160);
                } 
                
                else{
                    this.player.setVelocityX(0);
                    
                }
                if (this.cursors.up.isDown && this.player.body.onFloor() || this.clavier.SPACE.isDown && this.player.body.onFloor()){
                    this.player.setVelocityY(-250);
                }
                // Creation  du Wall Jump 
                if (this.cursors.up.isDown && this.player.body.blocked.right || this.clavier.SPACE.isDown && this.player.body.blocked.right) {
                    if (wallJump == true) {
                        wallJump = false;
                        offTouche = true;
                        setTimeout(cdWallJump, 500);
                        setTimeout(blocageTouche, 200);
                        this.player.setVelocityY(-pDeplacementY);
                        this.player.setVelocityX(-50);
                        
                    }
                }

                if (this.cursors.up.isDown && this.player.body.blocked.left || this.clavier.SPACE.isDown && this.player.body.blocked.left) {
                    if (wallJump == true) {
                        wallJump = false;
                        offTouche = true;
                        setTimeout(cdWallJump, 500);
                        setTimeout(blocageTouche, 200);
                        this.player.setVelocityY(-pDeplacementY);
                        this.player.setVelocityX(50);
                        
                    }
                }
                

            }
                
            </script>
        </body>
        </html>